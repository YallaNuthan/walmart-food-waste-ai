<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Walmart Waste Predictor</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      display: flex;
    }

    /* Sidebar Navigation */
    .sidebar {
      width: 220px;
      background-color: #007bff;
      color: white;
      height: 100vh;
      padding-top: 20px;
      position: fixed;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    .sidebar button {
      background: none;
      border: none;
      color: white;
      padding: 15px;
      text-align: left;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
    }

    .sidebar button:hover {
      background-color: #0056b3;
    }

    .main-content {
      margin-left: 220px;
      padding: 30px;
      flex: 1;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .container {
      background-color: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button[type="submit"] {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
    }

    .result {
      margin-top: 10px;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    .pagination {
      margin-top: 15px;
      text-align: center;
    }

    .pagination button {
      margin: 0 5px;
      padding: 6px 12px;
      border: 1px solid #007bff;
      background: white;
      color: #007bff;
      cursor: pointer;
    }

    .pagination button.active {
      background-color: #007bff;
      color: white;
    }

    .badge {
      font-size: 20px;
    }

    .Donate { color: red; font-weight: bold; }
    .Transfer { color: orange; font-weight: bold; }
    .Keep { color: green; font-weight: bold; }

  </style>
</head>
<body>

  <div class="sidebar">
    <h2>🏬 Walmart</h2>
    <button onclick="showPage('page1')">📈 Demand Forecast</button>
    <button onclick="showPage('page2')">🗑 Waste Risk</button>
    <button onclick="showPage('page3')">📦 Smart Recommendations</button>
    <button onclick="showPage('page4')">🏆 AI Leaderboard</button>
  </div>

  <div class="main-content">

    <div class="page active" id="page1">
      <div class="container">
        <h2>📈 Demand Forecast</h2>
        <form id="forecastForm">
          <label>Previous Sales</label>
          <input type="number" name="previous_sales" required />
          <label>Current Stock</label>
          <input type="number" name="stock" required />
          <label>Temperature (°C)</label>
          <input type="number" name="temperature_C" required />
          <button type="submit">Forecast</button>
        </form>
        <div class="result" id="forecastResult"></div>
      </div>
    </div>

    <div class="page" id="page2">
      <div class="container">
        <h2>🗑 Waste Risk Prediction</h2>
        <form id="predictForm">
          <label>Shelf Life (Days)</label>
          <input type="number" name="shelf_life_days" required />
          <label>Current Stock</label>
          <input type="number" name="current_stock" required />
          <label>Sold Last 7 Days</label>
          <input type="number" name="sold_last_7_days" required />
          <label>Forecasted Demand</label>
          <input type="number" name="forecasted_demand" required />
          <label>Temperature (°C)</label>
          <input type="number" name="temperature_C" required />
          <label>Humidity (%)</label>
          <input type="number" name="humidity_percent" required />
          <label>Category</label>
          <select name="category">
            <option value="Dairy">Dairy</option>
            <option value="Fruit">Fruit</option>
            <option value="Meat">Meat</option>
            <option value="Vegetable">Vegetable</option>
          </select>
          <button type="submit">Predict</button>
        </form>
        <div class="result" id="predictResult"></div>
      </div>
    </div>

    <div class="page" id="page3">
      <div class="container">
        <h2>📦 Smart Bulk Recommendations</h2>
        <label>Upload CSV (product_id, name, category, stock, expiry_date, store_location, freshness_score)</label>
        <input type="file" id="csvInput" />
        <button onclick="uploadCSV()">📤 Upload & Get Recommendations</button>
        <button onclick="loadRecommendations()">🔄 Load Recommendations (Demo)</button>
        <table id="recommendationTable">
          <thead>
            <tr>
              <th>Name</th><th>Store</th><th>Category</th><th>Stock</th><th>Freshness</th>
              <th>Expiry Status</th><th>Daily Demand</th><th>Risk</th><th>Recommendation</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="paginationControls"></div>
      </div>
    </div>

    <div class="page" id="page4">
      <div class="container">
        <h2>🏆 AI Waste Leaderboard</h2>
        <form id="aiUploadForm" enctype="multipart/form-data">
          <label>Upload Store Waste Report CSV (with date in dd-mm-yyyy)</label>
          <input type="file" name="file" required />
          <button type="submit">Upload & Score</button>
        </form>
        <div id="aiUploadResult" class="result"></div>
        <hr />
        <h3>📅 Daily Leaderboard</h3>
        <button onclick="loadAIDailyLeaderboard()">🔄 Load Daily</button>
        <table id="aiDailyLeaderboard"><thead><tr>
          <th>Store</th><th>Donated</th><th>Reduced</th><th>Wasted</th><th>AI Score</th><th>Badge</th>
        </tr></thead><tbody></tbody></table>

        <h3>📆 Monthly Leaderboard</h3>
        <button onclick="loadAIMonthlyLeaderboard()">🔄 Load Monthly</button>
        <table id="aiMonthlyLeaderboard"><thead><tr>
          <th>Store</th><th>Total Donated</th><th>Total Reduced</th><th>Total Wasted</th><th>AI Score (avg)</th><th>🏆</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>

  </div>

<script>
const BASE = "https://walmart-waste-predictor.onrender.com";

function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// Page 1
document.getElementById("forecastForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = Object.fromEntries(new FormData(e.target).entries());
  payload.previous_sales = +payload.previous_sales;
  payload.stock = +payload.stock;
  payload.temperature_C = +payload.temperature_C;

  const res = await fetch(`${BASE}/forecast_demand`, {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  document.getElementById("forecastResult").innerText = data.forecasted_demand !== undefined
    ? `Forecasted Demand: ${data.forecasted_demand}` : `Error: ${data.error}`;
});

// Page 2
document.getElementById("predictForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = new FormData(e.target);
  const cat = form.get("category");
  const payload = {
    shelf_life_days: +form.get("shelf_life_days"),
    current_stock: +form.get("current_stock"),
    sold_last_7_days: +form.get("sold_last_7_days"),
    forecasted_demand: +form.get("forecasted_demand"),
    temperature_C: +form.get("temperature_C"),
    ["humidity_%"]: +form.get("humidity_percent"),
    category_Dairy: cat === "Dairy" ? 1 : 0,
    category_Fruit: cat === "Fruit" ? 1 : 0,
    category_Meat: cat === "Meat" ? 1 : 0,
    category_Vegetable: cat === "Vegetable" ? 1 : 0
  };
  const res = await fetch(`${BASE}/predict`, {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const result = await res.json();
  document.getElementById("predictResult").innerText = result.prediction || result.error;
});

// Page 3 CSV Upload
async function uploadCSV() {
  const file = document.getElementById("csvInput").files[0];
  if (!file) return alert("Select a file");
  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch(`${BASE}/upload_csv`, { method: "POST", body: formData });
  const result = await res.json();
  if (result.success) {
    allData = result.data;
    currentPage = 1;
    renderPage(currentPage);
  } else {
    alert(result.error);
  }
}

let allData = [], currentPage = 1, pageSize = 5;

function renderPage(page) {
  const tbody = document.querySelector("#recommendationTable tbody");
  tbody.innerHTML = "";
  const start = (page - 1) * pageSize, end = start + pageSize;
  allData.slice(start, end).forEach(row => {
    const tr = document.createElement("tr");
    const risk = row.expiry_risk === 1 ? "High" : "Low";
    const action = row.recommendation.includes("Donate") ? "Donate" :
                   row.recommendation.includes("Transfer") ? "Transfer" : "Keep";
    tr.innerHTML = `
      <td>${row.name}</td><td>${row.store_location}</td><td>${row.category}</td>
      <td>${row.stock}</td><td>${row.freshness_score}</td><td>${row.expiry_status}</td>
      <td>${row.daily_demand}</td><td>${risk}</td><td class="${action}">${row.recommendation}</td>
    `;
    tbody.appendChild(tr);
  });

  const container = document.getElementById("paginationControls");
  container.innerHTML = "";
  const totalPages = Math.ceil(allData.length / pageSize);
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.innerText = i;
    if (i === page) btn.classList.add("active");
    btn.onclick = () => { currentPage = i; renderPage(i); };
    container.appendChild(btn);
  }
}

async function loadRecommendations() {
  const res = await fetch(`${BASE}/bulk_recommendations`);
  allData = await res.json();
  currentPage = 1;
  renderPage(currentPage);
}

// Page 4: AI Upload
document.getElementById("aiUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = e.target.file.files[0];
  const formData = new FormData();
  formData.append("file", file);
  const res = await fetch(`${BASE}/upload_waste_ai`, { method: "POST", body: formData });
  const result = await res.json();
  document.getElementById("aiUploadResult").innerText = result.message || result.error;
});

async function loadAIDailyLeaderboard() {
  const res = await fetch(`${BASE}/ai_daily_leaderboard`);
  const data = await res.json();
  const tbody = document.querySelector("#aiDailyLeaderboard tbody");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.store_location}</td><td>${row.waste_donated_kg}</td>
      <td>${row.waste_reduced_kg}</td><td>${row.waste_generated_kg}</td>
      <td><b>${row.ai_score}</b></td><td>${row.badge}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadAIMonthlyLeaderboard() {
  const res = await fetch(`${BASE}/ai_monthly_leaderboard`);
  const data = await res.json();
  const tbody = document.querySelector("#aiMonthlyLeaderboard tbody");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.store_location}</td><td>${row.waste_donated_kg}</td>
      <td>${row.waste_reduced_kg}</td><td>${row.waste_generated_kg}</td>
      <td><b>${row.ai_score}</b></td><td>${row.badge}</td>`;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
